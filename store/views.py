import json
import random
from django.http import JsonResponse
from django.contrib.auth.models import User
from django.contrib.auth import authenticate, login, logout
from django.core.mail import send_mail
from store.models import document, folders, size
from django.db.models import Q

# Create your views here.

def register(request):
    if(request.method=="POST"):
        body=json.loads(request.body)
        x=User.objects.filter(Q(username=body['user']) | Q(email=body['mail']))
        if(x.exists()):
            msg={'msg':'Username already exist'}
            return JsonResponse(msg, status=401, safe=False)
        global otp
        otp[body['mail']]=random.randint(1000,10000)
        send_mail(
                'OTP for registeration',
                '''Hello {name}.
                This mail is send by the company CloudBox. Your otp for sign up is {o}.
                \n\n\nThis message is generated by the server so do not reply back to it.'''.format(name=body['fname'], o=otp),
                'sudhanshu.2125it1056@kiet.edu',
                [body['mail']],
                fail_silently=False
                 )
        msg={'msg':'Success'}
        return JsonResponse(msg, status=200, safe=False)


def otpverify(request):
    if(request.method=="POST"):
        body=json.loads(request.body)
        if(body['otp']==otp[body['mail']]):
            otp.pop(body['otp'])
            user=User.objects.create_user(body['user'], body['mail'], body['pass1'])
            user.first_name=body['fname']
            user.last_name=body['lname']
            user.save()
            send_mail(
                'Account Created Succesfully',
                '''Hello {name}.
                You have succesfully signed up on the cloudbox server.
                This is the confirmation mail send you by Cloudbox.
                \n\n\n
                This message is generated by the server so do not reply back to it.'''.format(name=body['fname']),
                'sudhanshu.2125it1056@kiet.edu',
                [body['mail']],
                fail_silently=False
            )
            msg={'msg':'Account created'}
            return JsonResponse(msg, status=201, safe=False)
        else:
            msg={'msg':'OTP did not matched'}
            return JsonResponse(msg, status=401, safe=False)


def log_in(request):
    if(request.method=="POST"):
        body=json.loads(request.body)
        user=authenticate(username=body['user'], password=body['pass1'])
        if(user is not None):
            login(request, user)
            print(user.id)
            request.session['id']=user.id
            msg={'msg':'Success'}
            return JsonResponse(msg, status=200, safe=False)
        else:
            msg={'msg':'Wrong credentials'}
            return JsonResponse(msg, status=401, safe=False)


def upload(request):
    if(request.method=="POST"):
        if(request.user.is_authenticated):
            body=request.FILES
            p=request.POST
            print(p)
            print(body.keys())
            f=body['file']
            print(f)
            u=User.objects.get(id=request.user.id)
            x=folders.objects.get(id=p['id'])
            print(body['file'].size)
            doc=document(file=f, user=u, folder=x, byte=body['file'].size)
            doc.save()
            s=document.objects.filter(folder=x, user=u)
            space=0
            for i in s:
                space=space+i.byte
            space=space/(1024*1024)
            y=folders.objects.get(folder_name=x, user=u)
            y.size=space
            y.save()
            msg={'msg':'success'}
            return JsonResponse(msg, status=200, safe=False)
        else:
            msg={'msg':'Unauthorized'}
            return JsonResponse(msg, safe=False, status=401)


# def files(request):
#     if(request.user.is_authenticated):
#         doc=loc.objects.filter(user=request.user.id)
#         d=[]
#         for i in doc:
#             x=document.objects.get(id=i.user)
#             s={'file':x.file}
#             d.append(s)
#         return JsonResponse(d, status=200, safe=False)


def details(request):
    if(request.user.is_authenticated):
        print(request.user)
        x={'fname':request.user.first_name,'lname':request.user.last_name,'user':request.user.username,'mail':request.user.email}
        return JsonResponse(x, status=200, safe=False)
    else:
        msg={'msg':'Unauthorized'}
        return JsonResponse(msg, safe=False, status=401)


def fold(request):
    if(request.user.is_authenticated):
        u=User.objects.get(id=request.user.id)
        x=list(folders.objects.filter(user=u).distinct().values())
        print(x)
        return JsonResponse(x, safe=False, status=200)
    else:
        msg={'msg':'Unauthorized'}
        return JsonResponse(msg, safe=False, status=401)


def addfolder(request):
    if(request.user.is_authenticated):
        body=json.loads(request.body)
        u=User.objects.get(id=request.user.id)
        f=folders.objects.create(user=u, name=body['name'])
        msg={'msg':'Success'}
        return JsonResponse(msg, status=200, safe=False)
    else:
        msg={'msg':'Unauthorized'}
        return JsonResponse(msg, safe=False, status=401)


def files(request):
    if(request.user.is_authenticated and request.method=="POST"):
        body=json.loads(request.body)
        u=User.objects.get(id=request.user.id)
        f=folders.objects.get(id=body['id'])
        l=list(document.objects.filter(folder=f, user=u).values())
        return JsonResponse(l, safe=False, status=200)
    else:
        msg={'msg':'Unauthorized'}
        return JsonResponse(msg, safe=False, status=401)


def setsize(request):
    if(request.user.is_authenticated and request.user.is_superuser and request.method=="POST"):
        body=json.loads(request.body)
        size.objects.create(type=body['type'], size=body['size'])
        msg={'msg':'Success'}
        return JsonResponse(msg, safe=False, status=200)


def recent_file(request):
    if(request.user.is_authenticated):
        u=User.objects.get(id=request.user.id)
        doc=list(document.objects.filter(user=u).order_by('recent').values())
        return JsonResponse(doc, status=200, safe=False)


# def fold_size(request):
#     if(request.user.is_authenticated):
#         x=list(foldsize.objects.all().values())
#         return JsonResponse(x, safe=False, status=200)


def out(request):
    logout(request)
    msg={'msg':'Logout successfull'}
    return JsonResponse(msg, status=200, safe=False)
